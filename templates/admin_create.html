{% extends "layout.html" %}
{% block content %}
<div class="card shadow-sm">
  <div class="card-header">
    <h5 class="mb-0">Yeni Anket Olu≈ütur</h5>
  </div>
  <div class="card-body">
    <form id="create-form">
      <div class="mb-3">
        <label for="poll-id" class="form-label">Anket ID</label>
        <input type="number" id="poll-id" class="form-control" required>
      </div>

      <div class="mb-3">
        <label for="poll-question" class="form-label">Soru</label>
        <input type="text" id="poll-question" class="form-control" required>
      </div>

      <h6 class="mt-4">Se√ßenekler</h6>
      <div id="options-wrapper" class="mb-3"></div>

      <button type="button" id="add-opt" class="btn btn-sm btn-secondary mb-3">+ ≈ûƒ±k Ekle</button>
      <br>
      <button type="submit" id="save-btn" class="btn btn-success">Kaydet</button>
      <div id="save-alert" class="mt-3"></div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // JWT kontrol√º
  const token = localStorage.getItem("token");
  if (!token) location.href = "/login";

  let optCounter = 1;
  const wrap = document.getElementById("options-wrapper");

  function addOption(id) {
    wrap.insertAdjacentHTML("beforeend", `
      <div class="input-group mb-2" data-opt="${id}">
        <span class="input-group-text">#${id}</span>
        <input type="text" class="form-control" placeholder="Se√ßenek metni" required>
        <button type="button" class="btn btn-outline-danger" onclick="this.closest('[data-opt]').remove()">üóë</button>
      </div>`);
  }

  // sayfa ilk y√ºklendiƒüinde iki ≈üƒ±k hazƒ±rla
  addOption(optCounter++);
  addOption(optCounter++);

  document.getElementById("add-opt").addEventListener("click", () => addOption(optCounter++));

  document.getElementById("create-form").addEventListener("submit", e => {
    e.preventDefault();
    const id = Number(document.getElementById("poll-id").value);
    const question = document.getElementById("poll-question").value.trim();
    if (!id || !question) return;

    const options = Array.from(wrap.querySelectorAll("[data-opt]")).map(div => {
      const optId = Number(div.dataset.opt);
      const text  = div.querySelector("input").value.trim();
      return { id: optId, text, votes: 0 };
    });

    fetch("/api/polls", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + token
      },
      body: JSON.stringify({ id, question, options })
    })
    .then(r => r.json().then(j => ({ ok: r.ok, j })))
    .then(({ ok, j }) => {
      const alertBox = document.getElementById("save-alert");
      if (ok) {
        alertBox.innerHTML = '<div class="alert alert-success">‚úÖ Anket kaydedildi</div>';
        setTimeout(() => location.href = "/admin", 1000);
      } else {
        alertBox.innerHTML = `<div class="alert alert-danger">‚ùå ${j.detail}</div>`;
      }
    })
    .catch(err => console.error(err));
  });
</script>
{% endblock %}
