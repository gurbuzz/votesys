{% extends "layout.html" %}
{% block content %}
<div class="card shadow-sm mx-auto" style="max-width:600px;">
  <div class="card-header bg-warning text-dark">
    <h5 id="question" class="mb-0">Yükleniyor…</h5>
  </div>
  <div class="card-body">
    <form id="vote-form"></form>
    <div class="d-grid">
      <button id="vote-btn" class="btn btn-success mt-3">Oy Ver</button>
    </div>
    <div id="result" class="mt-3"></div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(async () => {
  const token = localStorage.getItem("token");
  if (!token) return void(location.href = "/login");

  const params = new URLSearchParams(window.location.search);
  const pollId = params.get("id");
  const qEl    = document.getElementById("question");
  const form   = document.getElementById("vote-form");
  const result = document.getElementById("result");

  if (!pollId) {
    qEl.textContent = "Geçersiz anket ID";
    return;
  }

  try {
    const res = await fetch(`/api/polls/${pollId}`, {
      headers: { "Authorization": "Bearer " + token }
    });
    if (!res.ok) throw new Error("Anket bulunamadı");
    const poll = await res.json();

    qEl.textContent = poll.question;
    form.innerHTML = "";
    poll.options.forEach(opt => {
      form.insertAdjacentHTML("beforeend", `
        <div class="form-check mb-2">
          <input class="form-check-input" type="radio" name="opt" id="opt${opt.id}" value="${opt.id}">
          <label class="form-check-label" for="opt${opt.id}">
            ${opt.text} (<span id="votes${opt.id}">${opt.votes}</span> oy)
          </label>
        </div>`);
    });
  } catch (err) {
    qEl.textContent = err.message;
    console.error(err);
    return;
  }

  document.getElementById("vote-btn").addEventListener("click", async () => {
    const sel = form.querySelector("input[name='opt']:checked");
    if (!sel) {
      alert("Lütfen bir seçenek seçin.");
      return;
    }
    try {
      const updated = await fetch(`/api/polls/${pollId}/vote`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + token
        },
        body: JSON.stringify({ option_id: Number(sel.value) })
      }).then(r => {
        if (!r.ok) throw new Error("Oy verilemedi");
        return r.json();
      });

      updated.options.forEach(o => {
        const span = document.getElementById(`votes${o.id}`);
        if (span) span.textContent = o.votes;
      });
      result.innerHTML = '<div class="alert alert-success">✅ Oy kaydedildi!</div>';
    } catch (err) {
      result.innerHTML = `<div class="alert alert-danger">❌ ${err.message}</div>`;
      console.error(err);
    }
  });
})();
</script>
{% endblock %}
